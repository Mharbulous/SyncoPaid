name: Story Tree Orchestrator

# Looping workflow that drains the pipeline before adding new work (v4 design)
# Runs: plan-stories FIRST (drain approved), then write-stories (fill capacity)
# Loops until both NO_APPROVED and NO_CAPACITY, or max_cycles reached

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 2:00 AM PST (10:00 UTC)
  workflow_dispatch:
    inputs:
      max_cycles:
        type: number
        default: 10
        description: Maximum loop iterations (safety limit)

concurrency:
  group: story-tree-automation
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  # Job 1: Check if automation is enabled
  gate:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    steps:
      - name: Check automation switch
        id: check
        run: |
          if [ "${{ vars.STORY_AUTOMATION_ENABLED }}" = "false" ]; then
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::notice::Story automation is DISABLED via repository variable"
          else
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "::notice::Story automation is ENABLED"
          fi

  # Job 2: Loop planâ†’write until pipeline is idle
  drain-pipeline:
    needs: gate
    if: needs.gate.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    outputs:
      cycles_completed: ${{ steps.loop.outputs.cycles_completed }}
      plans_created: ${{ steps.loop.outputs.plans_created }}
      stories_created: ${{ steps.loop.outputs.stories_created }}
      exit_reason: ${{ steps.loop.outputs.exit_reason }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run drain pipeline loop
        id: loop
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          MAX_CYCLES=${{ inputs.max_cycles || 10 }}
          cycle=0
          plans_created=0
          stories_created=0
          exit_reason="MAX_CYCLES"

          echo "Starting drain-pipeline loop (max $MAX_CYCLES cycles)"

          while [ $cycle -lt $MAX_CYCLES ]; do
            echo ""
            echo "=========================================="
            echo "CYCLE $((cycle + 1)) of $MAX_CYCLES"
            echo "=========================================="

            plan_result="NO_APPROVED"
            write_result="NO_CAPACITY"

            # Step 1: Plan stories (drain approved backlog)
            echo ""
            echo "--- Step 1: Check for approved stories ---"
            approved=$(sqlite3 .claude/data/story-tree.db "SELECT COUNT(*) FROM story_nodes WHERE status='approved'" 2>/dev/null || echo "0")
            echo "Approved stories waiting: $approved"

            if [ "$approved" -gt 0 ]; then
              echo "Planning approved story..."

              # Pull latest before planning
              git pull origin main --rebase || true

              # Invoke Claude Code for planning
              claude --print --dangerously-skip-permissions \
                --allowedTools "Task,Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(sqlite3:*),Skill,SlashCommand,TodoWrite" \
                --model claude-sonnet-4-5-20250929 \
                "MODE: Story Planning (CI - autonomous)

              Use the story-planning-ci skill to plan ONE approved story:
              1. Query approved stories from .claude/data/story-tree.db
              2. Create compact TDD plan in ai_docs/Plans/
              3. Update story status to 'planned'

              Execute: Skill(skill=\"story-planning-ci\")

              After planning, DO NOT commit - the orchestrator handles git operations." || {
                echo "::warning::Claude Code planning step returned non-zero"
              }

              # Check if files changed
              if [ -n "$(git status --porcelain)" ]; then
                git add -A
                git commit -m "ci: plan story (cycle $((cycle + 1)))"
                git push origin main
                plans_created=$((plans_created + 1))
                plan_result="SUCCESS"
                echo "Plan created and pushed"
              else
                echo "No changes from planning step"
              fi
            else
              echo "No approved stories to plan"
            fi

            # Step 2: Write stories (fill capacity)
            echo ""
            echo "--- Step 2: Check for capacity ---"

            # Pull latest before writing
            git pull origin main --rebase || true

            capacity_output=$(python .claude/scripts/story_workflow.py --ci 2>&1) || true
            echo "Capacity check output:"
            echo "$capacity_output" | head -20

            if echo "$capacity_output" | grep -q "NO_CAPACITY"; then
              echo "All nodes at capacity"
            else
              echo "Capacity available, generating story..."

              # Parse target info from JSON output
              target_json="$capacity_output"

              # Invoke Claude Code for story generation
              claude --print --dangerously-skip-permissions \
                --allowedTools "Task,Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(sqlite3:*),Skill,SlashCommand,TodoWrite" \
                --model claude-sonnet-4-5-20250929 \
                "MODE: Story Generation (CI - autonomous)

              Context from story_workflow.py:
              $target_json

              Generate ONE user story for the target node:
              1. Review target description and existing children
              2. Create story in format: As a [role] / I want [capability] / So that [benefit]
              3. Include 3-5 acceptance criteria
              4. Insert using: python .claude/scripts/insert_story.py \"<next_id>\" \"<parent_id>\" \"<title>\" \"<description>\"
              5. Update commit: python .claude/scripts/insert_story.py --update-commit \"<newest_commit>\"

              DO NOT commit - the orchestrator handles git operations." || {
                echo "::warning::Claude Code story generation returned non-zero"
              }

              # Check if files changed (database modified)
              if [ -n "$(git status --porcelain)" ]; then
                git add -A
                git commit -m "ci: add story (cycle $((cycle + 1)))"
                git push origin main
                stories_created=$((stories_created + 1))
                write_result="SUCCESS"
                echo "Story created and pushed"
              else
                echo "No changes from story generation"
                # Even if no git changes, if we got JSON output, capacity exists
                # but Claude didn't create anything - still count as capacity available
                if echo "$capacity_output" | grep -q '"target"'; then
                  write_result="SUCCESS"  # Claude ran but didn't produce output
                fi
              fi
            fi

            # Check exit condition
            echo ""
            echo "--- Cycle Results ---"
            echo "Plan result: $plan_result"
            echo "Write result: $write_result"

            if [ "$plan_result" = "NO_APPROVED" ] && [ "$write_result" = "NO_CAPACITY" ]; then
              echo "Pipeline is IDLE - both stages have no work"
              exit_reason="IDLE"
              break
            fi

            cycle=$((cycle + 1))
          done

          # Report final status
          echo ""
          echo "=========================================="
          echo "LOOP COMPLETE"
          echo "=========================================="
          echo "Cycles completed: $((cycle))"
          echo "Plans created: $plans_created"
          echo "Stories created: $stories_created"
          echo "Exit reason: $exit_reason"

          # Set outputs
          echo "cycles_completed=$cycle" >> $GITHUB_OUTPUT
          echo "plans_created=$plans_created" >> $GITHUB_OUTPUT
          echo "stories_created=$stories_created" >> $GITHUB_OUTPUT
          echo "exit_reason=$exit_reason" >> $GITHUB_OUTPUT

  # Job 3: Generate summary
  summary:
    needs: [gate, drain-pipeline]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate pipeline summary
        run: |
          echo "## Story Tree Orchestrator Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.gate.outputs.enabled }}" = "false" ]; then
            echo "**Status:** Automation is DISABLED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Set \`STORY_AUTOMATION_ENABLED\` repository variable to \`true\` to enable." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Cycles Completed | ${{ needs.drain-pipeline.outputs.cycles_completed || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Plans Created | ${{ needs.drain-pipeline.outputs.plans_created || '0' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Stories Created | ${{ needs.drain-pipeline.outputs.stories_created || '0' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Exit Reason | ${{ needs.drain-pipeline.outputs.exit_reason || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            exit_reason="${{ needs.drain-pipeline.outputs.exit_reason }}"
            case "$exit_reason" in
              "IDLE")
                echo "**Exit Reason:** Pipeline fully drained - no approved stories and no capacity for new stories." >> $GITHUB_STEP_SUMMARY
                ;;
              "MAX_CYCLES")
                echo "**Exit Reason:** Safety limit reached. Consider running again or increasing \`max_cycles\`." >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "**Exit Reason:** $exit_reason" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          fi
