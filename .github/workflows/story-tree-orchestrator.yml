name: "Story Tree Orchestrator"

# Looping workflow that drains the pipeline before adding new work (v4 design)
# Runs: plan-stories FIRST (drain approved), then write-stories (fill capacity), then vet-stories (resolve conflicts)
# Loops until both NO_APPROVED and NO_CAPACITY, or max_cycles reached

on:
  # schedule disabled - manual trigger only
  workflow_dispatch:
    inputs:
      max_cycles:
        type: number
        default: 5
        description: Maximum loop iterations (safety limit)

concurrency:
  group: story-tree-automation
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  # Job 1: Check if automation is enabled
  gate:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    steps:
      - name: Check automation switch
        id: check
        run: |
          if [ "${{ vars.STORY_AUTOMATION_ENABLED }}" = "false" ]; then
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::notice::Story automation is DISABLED via repository variable"
          else
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "::notice::Story automation is ENABLED"
          fi

  # Job 2: Loop planâ†’write until pipeline is idle
  drain-pipeline:
    needs: gate
    if: needs.gate.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    outputs:
      cycles_completed: ${{ steps.loop.outputs.cycles_completed }}
      plans_created: ${{ steps.loop.outputs.plans_created }}
      stories_created: ${{ steps.loop.outputs.stories_created }}
      vetting_actions: ${{ steps.loop.outputs.vetting_actions }}
      exit_reason: ${{ steps.loop.outputs.exit_reason }}
      progress_file: ${{ steps.loop.outputs.progress_file }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI and jq
        run: |
          npm install -g @anthropic-ai/claude-code
          sudo apt-get update && sudo apt-get install -y jq

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run drain pipeline loop
        id: loop
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          MAX_CYCLES=${{ inputs.max_cycles || 5 }}
          cycle=0
          plans_created=0
          stories_created=0
          vetting_actions=0
          exit_reason="MAX_CYCLES"

          # Setup progress file
          TODAY=$(date -u +"%Y-%m-%d")
          PROGRESS_FILE=".claude/data/github_action_results/${TODAY}-GitHub-Actions-Results.md"
          mkdir -p .claude/data/github_action_results

          # Initialize progress file with header (using echo to avoid heredoc YAML issues)
          echo "# Story Tree Orchestrator Progress" > "$PROGRESS_FILE"
          echo "" >> "$PROGRESS_FILE"
          echo "> Auto-generated by GitHub Actions workflow" >> "$PROGRESS_FILE"
          echo "" >> "$PROGRESS_FILE"
          echo "## Run Details" >> "$PROGRESS_FILE"
          echo "" >> "$PROGRESS_FILE"
          echo "| Field | Value |" >> "$PROGRESS_FILE"
          echo "|-------|-------|" >> "$PROGRESS_FILE"
          echo "| Run Date | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> "$PROGRESS_FILE"
          echo "| Max Cycles | $MAX_CYCLES |" >> "$PROGRESS_FILE"
          echo "| Workflow Run | [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> "$PROGRESS_FILE"
          echo "" >> "$PROGRESS_FILE"
          echo "## Step Results" >> "$PROGRESS_FILE"
          echo "" >> "$PROGRESS_FILE"
          echo "| Cycle | Step | Story ID | Action | Files Changed | Input Tokens | Output Tokens | Cost USD | Commit Time |" >> "$PROGRESS_FILE"
          echo "|-------|------|----------|--------|---------------|--------------|---------------|----------|-------------|" >> "$PROGRESS_FILE"

          echo "Starting drain-pipeline loop (max $MAX_CYCLES cycles)"
          echo "Progress file: $PROGRESS_FILE"

          while [ $cycle -lt $MAX_CYCLES ]; do
            echo ""
            echo "=========================================="
            echo "CYCLE $((cycle + 1)) of $MAX_CYCLES"
            echo "=========================================="

            plan_result="NO_APPROVED"
            write_result="NO_CAPACITY"

            # Step 1: Plan stories (drain approved backlog)
            echo ""
            echo "--- Step 1: Check for approved stories ---"

            # Get approved story details before planning (single-line Python to avoid YAML issues)
            approved_info=$(python3 -c "import sqlite3; conn = sqlite3.connect('.claude/data/story-tree.db'); rows = conn.execute('SELECT id, title FROM story_nodes WHERE stage=\"approved\" AND hold_reason IS NULL AND disposition IS NULL ORDER BY id LIMIT 1').fetchall(); print(f'{rows[0][0]}|{rows[0][1][:50]}' if rows else 'NONE')" 2>/dev/null || echo "NONE")

            approved_id=$(echo "$approved_info" | cut -d'|' -f1)
            approved_title=$(echo "$approved_info" | cut -d'|' -f2)

            if [ "$approved_id" != "NONE" ]; then
              echo "Planning story: $approved_id - $approved_title"

              # Pull latest before planning
              git pull origin main --rebase || true

              # Invoke Claude Code for planning with JSON output
              claude_output=$(claude --print --dangerously-skip-permissions \
                --output-format json \
                --allowedTools "Task,Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(sqlite3:*),Bash(pip:*),BashOutput,Skill,SlashCommand,TodoWrite" \
                --model claude-opus-4-5-20251101 \
                "MODE: Story Planning (CI - autonomous)

              Use the story-planning skill to plan ONE approved story (CI mode auto-detected):
              1. Query approved stories from .claude/data/story-tree.db
              2. Create compact TDD plan in .claude/data/plans/
              3. Update story status to 'planned'

              Execute: Skill(skill=\"story-planning\")

              After planning, DO NOT commit - the orchestrator handles git operations." 2>&1) || {
                echo "::warning::Claude Code planning step returned non-zero"
              }

              # Parse token usage from JSON output
              input_tokens=$(echo "$claude_output" | jq -r '.usage.input_tokens // 0' 2>/dev/null || echo "0")
              output_tokens=$(echo "$claude_output" | jq -r '.usage.output_tokens // 0' 2>/dev/null || echo "0")
              cost_usd=$(echo "$claude_output" | jq -r '.total_cost_usd // 0' 2>/dev/null || echo "0")

              # Get files changed
              files_changed=$(git status --porcelain | wc -l | tr -d ' ')
              plan_files=$(git status --porcelain | grep -E "\.md$" | head -1 | sed 's/^.. //' || echo "")

              # Check if files changed
              if [ -n "$(git status --porcelain)" ]; then
                git add -A
                git commit -m "planning: create implementation plan for story $approved_id"
                git push origin main
                commit_time=$(date -u +"%Y-%m-%d %H:%M:%S")
                plans_created=$((plans_created + 1))
                plan_result="SUCCESS"

                # Log to progress file
                echo "| $((cycle + 1)) | Plan | $approved_id | approvedâ†’planned | $files_changed | $input_tokens | $output_tokens | \$$cost_usd | $commit_time |" >> "$PROGRESS_FILE"

                echo "Plan created and pushed"
              else
                echo "No changes from planning step"
                # Log skipped step
                echo "| $((cycle + 1)) | Plan | $approved_id | (no changes) | 0 | $input_tokens | $output_tokens | \$$cost_usd | - |" >> "$PROGRESS_FILE"
              fi
            else
              echo "No approved stories to plan"
            fi

            # Step 2: Write stories (fill capacity)
            echo ""
            echo "--- Step 2: Check for capacity ---"

            # Pull latest before writing
            git pull origin main --rebase || true

            capacity_output=$(python .claude/scripts/story_workflow.py --ci 2>&1) || true
            echo "Capacity check output:"
            echo "$capacity_output" | head -20

            if echo "$capacity_output" | grep -q "NO_CAPACITY"; then
              echo "All nodes at capacity"
            else
              echo "Capacity available, generating story..."

              # Parse target info from JSON output
              target_json="$capacity_output"
              target_id=$(echo "$capacity_output" | jq -r '.target.id // "unknown"' 2>/dev/null || echo "unknown")
              next_id=$(echo "$capacity_output" | jq -r '.next_id // "unknown"' 2>/dev/null || echo "unknown")

              # Invoke Claude Code for story generation with JSON output
              claude_output=$(claude --print --dangerously-skip-permissions \
                --output-format json \
                --allowedTools "Task,Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(sqlite3:*),Bash(pip:*),BashOutput,Skill,SlashCommand,TodoWrite" \
                --model claude-sonnet-4-5-20250929 \
                "MODE: Story Generation (CI - autonomous)

              Context from story_workflow.py:
              $target_json

              Generate ONE user story for the target node:
              1. Review target description and existing children
              2. Create story in format: As a [role] / I want [capability] / So that [benefit]
              3. Include 3-5 acceptance criteria
              4. Insert using: python .claude/scripts/insert_story.py \"<next_id>\" \"<parent_id>\" \"<title>\" \"<description>\"
              5. Update commit: python .claude/scripts/insert_story.py --update-commit \"<newest_commit>\"

              DO NOT commit - the orchestrator handles git operations." 2>&1) || {
                echo "::warning::Claude Code story generation returned non-zero"
              }

              # Parse token usage from JSON output
              input_tokens=$(echo "$claude_output" | jq -r '.usage.input_tokens // 0' 2>/dev/null || echo "0")
              output_tokens=$(echo "$claude_output" | jq -r '.usage.output_tokens // 0' 2>/dev/null || echo "0")
              cost_usd=$(echo "$claude_output" | jq -r '.total_cost_usd // 0' 2>/dev/null || echo "0")

              # Get files changed
              files_changed=$(git status --porcelain | wc -l | tr -d ' ')

              # Check if files changed (database modified)
              if [ -n "$(git status --porcelain)" ]; then
                git add -A
                git commit -m "ci: add story (cycle $((cycle + 1)))"
                git push origin main
                commit_time=$(date -u +"%Y-%m-%d %H:%M:%S")
                stories_created=$((stories_created + 1))
                write_result="SUCCESS"

                # Log to progress file
                echo "| $((cycle + 1)) | Write | $next_id | newâ†’concept | $files_changed | $input_tokens | $output_tokens | \$$cost_usd | $commit_time |" >> "$PROGRESS_FILE"

                echo "Story created and pushed"
              else
                echo "No changes from story generation"
                # Log skipped step
                echo "| $((cycle + 1)) | Write | $next_id | (no changes) | 0 | $input_tokens | $output_tokens | \$$cost_usd | - |" >> "$PROGRESS_FILE"

                # Even if no git changes, if we got JSON output, capacity exists
                # but Claude didn't create anything - still count as capacity available
                if echo "$capacity_output" | grep -q '"target"'; then
                  write_result="SUCCESS"  # Claude ran but didn't produce output
                fi
              fi
            fi

            # Step 3: Vet stories (resolve conflicts)
            echo ""
            echo "--- Step 3: Vet stories (resolve conflicts) ---"

            # Pull latest before vetting
            git pull origin main --rebase || true

            # Invoke Claude Code for story vetting with JSON output
            vet_output=$(claude --print --dangerously-skip-permissions \
              --output-format json \
              --allowedTools "Task,Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(sqlite3:*),Bash(pip:*),BashOutput,Skill,SlashCommand,TodoWrite" \
              --model claude-sonnet-4-5-20250929 \
              "MODE: Story Vetting (CI - autonomous)

            Invoke the story-vetting skill to detect and resolve conflicting concepts.
            CI mode is ACTIVE - use DEFER_PENDING for HUMAN_REVIEW cases.

            Execute: Skill(skill=\"story-vetting\")

            After vetting, DO NOT commit - the orchestrator handles git operations." 2>&1) || {
              echo "::warning::Claude Code vetting step returned non-zero"
            }

            # Parse token usage from JSON output
            vet_input_tokens=$(echo "$vet_output" | jq -r '.usage.input_tokens // 0' 2>/dev/null || echo "0")
            vet_output_tokens=$(echo "$vet_output" | jq -r '.usage.output_tokens // 0' 2>/dev/null || echo "0")
            vet_cost_usd=$(echo "$vet_output" | jq -r '.total_cost_usd // 0' 2>/dev/null || echo "0")

            # Extract pending count for logging (concepts deferred for human review)
            pending_count=$(echo "$vet_output" | grep -oP 'pending: \K\d+' || echo "0")
            if [ "$pending_count" -gt 0 ]; then
              echo "::warning::$pending_count conflicts need human review (set to pending)"
            fi

            # Get files changed
            vet_files_changed=$(git status --porcelain | wc -l | tr -d ' ')

            # Check if files changed from vetting
            if [ -n "$(git status --porcelain)" ]; then
              git add -A
              git commit -m "ci: vet stories (cycle $((cycle + 1)))"
              git push origin main
              vet_commit_time=$(date -u +"%Y-%m-%d %H:%M:%S")
              vetting_actions=$((vetting_actions + 1))

              # Log to progress file
              echo "| $((cycle + 1)) | Vet | - | conflicts resolved | $vet_files_changed | $vet_input_tokens | $vet_output_tokens | \$$vet_cost_usd | $vet_commit_time |" >> "$PROGRESS_FILE"

              echo "Vetting changes committed and pushed"
            else
              echo "No conflicts found or no changes needed"
              # Log skipped step
              echo "| $((cycle + 1)) | Vet | - | (no conflicts) | 0 | $vet_input_tokens | $vet_output_tokens | \$$vet_cost_usd | - |" >> "$PROGRESS_FILE"
            fi

            # Check exit condition
            echo ""
            echo "--- Cycle Results ---"
            echo "Plan result: $plan_result"
            echo "Write result: $write_result"

            if [ "$plan_result" = "NO_APPROVED" ] && [ "$write_result" = "NO_CAPACITY" ]; then
              echo "Pipeline is IDLE - both stages have no work"
              exit_reason="IDLE"
              break
            fi

            cycle=$((cycle + 1))
          done

          # Report final status
          echo ""
          echo "=========================================="
          echo "LOOP COMPLETE"
          echo "=========================================="
          echo "Cycles completed: $((cycle))"
          echo "Plans created: $plans_created"
          echo "Stories created: $stories_created"
          echo "Vetting actions: $vetting_actions"
          echo "Exit reason: $exit_reason"

          # Add summary section to progress file
          echo "" >> "$PROGRESS_FILE"
          echo "## Summary" >> "$PROGRESS_FILE"
          echo "" >> "$PROGRESS_FILE"
          echo "| Metric | Value |" >> "$PROGRESS_FILE"
          echo "|--------|-------|" >> "$PROGRESS_FILE"
          echo "| Cycles Completed | $cycle |" >> "$PROGRESS_FILE"
          echo "| Plans Created | $plans_created |" >> "$PROGRESS_FILE"
          echo "| Stories Created | $stories_created |" >> "$PROGRESS_FILE"
          echo "| Vetting Actions | $vetting_actions |" >> "$PROGRESS_FILE"
          echo "| Exit Reason | $exit_reason |" >> "$PROGRESS_FILE"
          echo "" >> "$PROGRESS_FILE"
          echo "---" >> "$PROGRESS_FILE"
          echo "*Generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> "$PROGRESS_FILE"

          # Commit progress file
          git pull origin main --rebase || true
          git add "$PROGRESS_FILE"
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ci: update progress report ($(date -u +%Y-%m-%d))"
            git push origin main
          fi

          # Set outputs
          echo "cycles_completed=$cycle" >> $GITHUB_OUTPUT
          echo "plans_created=$plans_created" >> $GITHUB_OUTPUT
          echo "stories_created=$stories_created" >> $GITHUB_OUTPUT
          echo "vetting_actions=$vetting_actions" >> $GITHUB_OUTPUT
          echo "exit_reason=$exit_reason" >> $GITHUB_OUTPUT
          echo "progress_file=$PROGRESS_FILE" >> $GITHUB_OUTPUT

  # Job 3: Generate summary from progress file
  summary:
    needs: [gate, drain-pipeline]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        if: needs.gate.outputs.enabled == 'true'
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 1

      - name: Generate pipeline summary
        run: |
          echo "## Story Tree Orchestrator Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.gate.outputs.enabled }}" = "false" ]; then
            echo "**Status:** Automation is DISABLED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Set \`STORY_AUTOMATION_ENABLED\` repository variable to \`true\` to enable." >> $GITHUB_STEP_SUMMARY
          else
            # Overall metrics
            echo "### Overall Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Cycles Completed | ${{ needs.drain-pipeline.outputs.cycles_completed || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Plans Created | ${{ needs.drain-pipeline.outputs.plans_created || '0' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Stories Created | ${{ needs.drain-pipeline.outputs.stories_created || '0' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Vetting Actions | ${{ needs.drain-pipeline.outputs.vetting_actions || '0' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Exit Reason | ${{ needs.drain-pipeline.outputs.exit_reason || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Read progress file for detailed step results
            PROGRESS_FILE="${{ needs.drain-pipeline.outputs.progress_file }}"
            if [ -n "$PROGRESS_FILE" ] && [ -f "$PROGRESS_FILE" ]; then
              echo "### Step Details" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Extract just the step results table from progress file
              sed -n '/| Cycle | Step |/,/^$/p' "$PROGRESS_FILE" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              echo "ðŸ“„ [Full progress report]($PROGRESS_FILE)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            exit_reason="${{ needs.drain-pipeline.outputs.exit_reason }}"
            case "$exit_reason" in
              "IDLE")
                echo "**Exit Reason:** Pipeline fully drained - no approved stories and no capacity for new stories." >> $GITHUB_STEP_SUMMARY
                ;;
              "MAX_CYCLES")
                max_cycles="${{ inputs.max_cycles || 10 }}"
                if [ "$max_cycles" -eq 1 ]; then
                  echo "**Exit Reason:** Test run completed (max_cycles=1)." >> $GITHUB_STEP_SUMMARY
                else
                  echo "**Exit Reason:** Safety limit reached. Consider running again or increasing \`max_cycles\`." >> $GITHUB_STEP_SUMMARY
                fi
                ;;
              *)
                echo "**Exit Reason:** $exit_reason" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          fi
