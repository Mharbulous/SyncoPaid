name: 4. Execute Story

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

concurrency:
  group: daily-story-execution
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# PIPELINE VISUALIZATION
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# This workflow uses multiple jobs connected via 'needs:' to display as a
# visual pipeline in GitHub Actions:
#
#   setup-and-plan ‚Üí review-plan ‚Üí batch-1 ‚Üí batch-2 ‚Üí batch-3 ‚Üí batch-4 ‚Üí finalize
#
# State is passed between jobs via:
# - Job outputs: simple strings (outcome, status, paths)
# - Artifacts: temp-CI-notes.json for complex state
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # SETUP-AND-PLAN: Phases 1-4
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  setup-and-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      plan_selected: ${{ steps.select-plan.outputs.selected }}
      plan_path: ${{ steps.select-plan.outputs.path }}
      plan_filename: ${{ steps.select-plan.outputs.filename }}
      plan_sequence: ${{ steps.select-plan.outputs.sequence }}
      story_id: ${{ steps.extract-story.outputs.story_id }}
      should_execute: ${{ steps.determine.outputs.should_execute }}
      skip_reason: ${{ steps.determine.outputs.skip_reason }}

    steps:
      # ‚îÄ‚îÄ PHASE 1: SETUP ‚îÄ‚îÄ
      - name: "1.1 Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # ‚îÄ‚îÄ PHASE 2: PLAN SELECTION ‚îÄ‚îÄ
      - name: "2.1 Find available plans"
        id: find-plans
        run: |
          echo "## Plan Discovery" >> $GITHUB_STEP_SUMMARY

          PLANS_DIR=".claude/data/plans"
          if [ ! -d "$PLANS_DIR" ]; then
            echo "plans_found=0" >> $GITHUB_OUTPUT
            echo "‚ùå Plans directory not found: $PLANS_DIR" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          PLAN_COUNT=$(find "$PLANS_DIR" -maxdepth 1 -name "*.md" -type f | wc -l)
          echo "plans_found=$PLAN_COUNT" >> $GITHUB_OUTPUT
          echo "Found **$PLAN_COUNT** plan files in $PLANS_DIR" >> $GITHUB_STEP_SUMMARY

          if [ "$PLAN_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Plan File | Sequence |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
            for f in $(ls -1 "$PLANS_DIR"/*.md 2>/dev/null | head -10); do
              FNAME=$(basename "$f")
              SEQ=$(echo "$FNAME" | grep -oP '^\d{3}[A-Z]?' || echo "?")
              echo "| $FNAME | $SEQ |" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: "2.2 Select earliest plan"
        id: select-plan
        if: steps.find-plans.outputs.plans_found != '0'
        run: |
          python3 << 'PYEOF'
          import os, re, json

          plans_dir = '.claude/data/plans'
          pattern = re.compile(r'^(\d{3})([A-Z])?_(.+)\.md$')

          plans = []
          for f in os.listdir(plans_dir):
              path = os.path.join(plans_dir, f)
              if os.path.isfile(path) and f.endswith('.md'):
                  m = pattern.match(f)
                  if m:
                      plans.append({
                          'filename': f,
                          'path': path,
                          'sequence': int(m.group(1)),
                          'letter': m.group(2) or '',
                      })

          plans.sort(key=lambda x: (x['sequence'], x['letter']))

          if plans:
              selected = plans[0]
              with open(os.environ['GITHUB_OUTPUT'], 'a') as out:
                  out.write(f"selected=true\n")
                  out.write(f"filename={selected['filename']}\n")
                  out.write(f"path={selected['path']}\n")
                  out.write(f"sequence={selected['sequence']}{selected['letter']}\n")
              print(f"Selected: {selected['filename']}")
          else:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as out:
                  out.write("selected=false\n")
              print("No valid plan files found")
          PYEOF

      - name: "2.3 Extract Story ID from plan"
        id: extract-story
        if: steps.select-plan.outputs.selected == 'true'
        run: |
          PLAN_PATH="${{ steps.select-plan.outputs.path }}"

          STORY_ID=$(grep -oP 'Story ID[:\s]*\K\d+(\.\d+)*' "$PLAN_PATH" | head -1)

          if [ -z "$STORY_ID" ]; then
            STORY_ID=$(grep -oP '\*\*Story ID:\*\*\s*\K\d+(\.\d+)*' "$PLAN_PATH" | head -1)
          fi

          echo "story_id=${STORY_ID:-none}" >> $GITHUB_OUTPUT
          echo "Story ID: ${STORY_ID:-'(not found)'}"

      # ‚îÄ‚îÄ PHASE 3: VALIDATION ‚îÄ‚îÄ
      - name: "3.1 Check if story already executed"
        id: check-executed
        if: steps.select-plan.outputs.selected == 'true' && steps.extract-story.outputs.story_id != 'none'
        run: |
          STORY_ID="${{ steps.extract-story.outputs.story_id }}"
          DB_PATH=".claude/data/story-tree.db"

          if [ ! -f "$DB_PATH" ]; then
            echo "already_executed=false" >> $GITHUB_OUTPUT
            echo "Database not found, assuming not executed"
            exit 0
          fi

          STAGE=$(python3 -c "
          import sqlite3
          conn = sqlite3.connect('$DB_PATH')
          r = conn.execute('SELECT stage FROM story_nodes WHERE id = ?', ('$STORY_ID',)).fetchone()
          print(r[0] if r else 'unknown')
          conn.close()
          ")

          echo "Current stage: $STAGE"

          case "$STAGE" in
            reviewing|verifying|implemented|ready|polish|released)
              echo "already_executed=true" >> $GITHUB_OUTPUT
              echo "current_stage=$STAGE" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Story $STORY_ID already at stage: $STAGE"
              ;;
            *)
              echo "already_executed=false" >> $GITHUB_OUTPUT
              echo "current_stage=$STAGE" >> $GITHUB_OUTPUT
              echo "‚úì Story $STORY_ID ready for execution (stage: $STAGE)"
              ;;
          esac

      - name: "3.2 Check story dependencies"
        id: check-deps
        if: steps.select-plan.outputs.selected == 'true' && steps.check-executed.outputs.already_executed != 'true'
        run: |
          STORY_ID="${{ steps.extract-story.outputs.story_id }}"
          PLAN_PATH="${{ steps.select-plan.outputs.path }}"
          DB_PATH=".claude/data/story-tree.db"

          if [ "$STORY_ID" = "none" ] || [ ! -f "$DB_PATH" ]; then
            echo "deps_met=true" >> $GITHUB_OUTPUT
            echo "No Story ID or database, skipping dependency check"
            exit 0
          fi

          python3 << PYEOF
          import sqlite3, re, os

          story_id = "$STORY_ID"
          db_path = "$DB_PATH"
          plan_path = "$PLAN_PATH"

          conn = sqlite3.connect(db_path)

          result = conn.execute('SELECT description, notes FROM story_nodes WHERE id = ?', (story_id,)).fetchone()
          if not result:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("deps_met=true\n")
              print("Story not in database, proceeding")
              exit(0)

          text = (result[0] or '') + ' ' + (result[1] or '')

          with open(plan_path, 'r') as f:
              text += ' ' + f.read()

          dep_pattern = r'(?:depends on|requires|after|blocked by)\s+(\d+(?:\.\d+)*)'
          deps = set(re.findall(dep_pattern, text, re.IGNORECASE))
          deps.discard(story_id)

          if not deps:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("deps_met=true\n")
              print("No dependencies found")
              exit(0)

          IMPLEMENTED = ('implemented', 'ready', 'polish', 'released')
          unmet = []
          for dep_id in deps:
              r = conn.execute('SELECT stage FROM story_nodes WHERE id = ? AND disposition IS NULL', (dep_id,)).fetchone()
              if r and r[0] not in IMPLEMENTED:
                  unmet.append(f"{dep_id} ({r[0]})")

          conn.close()

          if unmet:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("deps_met=false\n")
                  f.write(f"unmet_deps={', '.join(unmet)}\n")
              print(f"‚ùå Unmet dependencies: {', '.join(unmet)}")
          else:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("deps_met=true\n")
              print("‚úì All dependencies met")
          PYEOF

      # ‚îÄ‚îÄ PHASE 4: HANDLE SKIP CONDITIONS ‚îÄ‚îÄ
      - name: "4.1 Archive already-executed plan"
        if: steps.check-executed.outputs.already_executed == 'true'
        run: |
          PLAN_PATH="${{ steps.select-plan.outputs.path }}"
          FILENAME="${{ steps.select-plan.outputs.filename }}"
          ARCHIVE_DIR=".claude/data/executed"

          mkdir -p "$ARCHIVE_DIR"
          mv "$PLAN_PATH" "$ARCHIVE_DIR/"
          echo "Archived already-executed plan: $FILENAME ‚Üí $ARCHIVE_DIR/"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ci: archive already-executed plan $FILENAME"
          git push origin main

      - name: "4.2 Move blocked plan to blocked folder"
        if: steps.check-deps.outputs.deps_met == 'false'
        run: |
          PLAN_PATH="${{ steps.select-plan.outputs.path }}"
          FILENAME="${{ steps.select-plan.outputs.filename }}"
          BLOCKED_DIR=".claude/data/plans/blocked"
          UNMET="${{ steps.check-deps.outputs.unmet_deps }}"

          mkdir -p "$BLOCKED_DIR"
          mv "$PLAN_PATH" "$BLOCKED_DIR/"
          echo "Moved blocked plan: $FILENAME ‚Üí $BLOCKED_DIR/"
          echo "Unmet dependencies: $UNMET"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ci: move blocked plan $FILENAME (deps: $UNMET)"
          git push origin main

      # ‚îÄ‚îÄ DETERMINE IF EXECUTION SHOULD PROCEED ‚îÄ‚îÄ
      - name: "4.3 Determine execution eligibility"
        id: determine
        run: |
          SELECTED="${{ steps.select-plan.outputs.selected }}"
          ALREADY_EXECUTED="${{ steps.check-executed.outputs.already_executed }}"
          DEPS_MET="${{ steps.check-deps.outputs.deps_met }}"

          if [ "$SELECTED" != "true" ]; then
            echo "should_execute=false" >> $GITHUB_OUTPUT
            echo "skip_reason=no_plans" >> $GITHUB_OUTPUT
          elif [ "$ALREADY_EXECUTED" = "true" ]; then
            echo "should_execute=false" >> $GITHUB_OUTPUT
            echo "skip_reason=already_executed" >> $GITHUB_OUTPUT
          elif [ "$DEPS_MET" = "false" ]; then
            echo "should_execute=false" >> $GITHUB_OUTPUT
            echo "skip_reason=deps_unmet" >> $GITHUB_OUTPUT
          else
            echo "should_execute=true" >> $GITHUB_OUTPUT
            echo "skip_reason=" >> $GITHUB_OUTPUT
          fi

      # ‚îÄ‚îÄ INITIALIZE STATE FILE ‚îÄ‚îÄ
      - name: "4.4 Initialize temp-CI-notes.json"
        id: init-state
        if: steps.determine.outputs.should_execute == 'true'
        run: |
          STATE_FILE=".claude/skills/story-execution/temp-CI-notes.json"
          mkdir -p "$(dirname "$STATE_FILE")"
          cat > "$STATE_FILE" << EOF
          {
            "version": 1,
            "plan_file": "${{ steps.select-plan.outputs.filename }}",
            "story_id": "${{ steps.extract-story.outputs.story_id }}",
            "review": {"outcome": null, "blocking_issues": [], "deferrable_issues": [], "notes": null},
            "tasks": [],
            "batches": [],
            "current_batch": 0,
            "total_tasks": 0,
            "tasks_remaining": 0,
            "final_status": "not_started"
          }
          EOF
          echo "Initialized state file: $STATE_FILE"

      # ‚îÄ‚îÄ UPLOAD STATE ARTIFACT ‚îÄ‚îÄ
      - name: "4.5 Upload state artifact"
        if: steps.determine.outputs.should_execute == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/temp-CI-notes.json
          retention-days: 1

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # REVIEW-PLAN: Phase 5.1 - Claude reviews plan critically
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  review-plan:
    needs: setup-and-plan
    if: needs.setup-and-plan.outputs.should_execute == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      outcome: ${{ steps.review-output.outputs.outcome }}
      total_tasks: ${{ steps.review-output.outputs.total_tasks }}
      review_completed: ${{ steps.review-output.outputs.review_completed }}

    steps:
      - name: "5.1.0 Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: "5.1.1 Download state artifact"
        uses: actions/download-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/

      - name: "5.1.2 Review plan critically"
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Use story-execution skill in CI mode.
            Phase: REVIEW
            Plan: ${{ needs.setup-and-plan.outputs.plan_path }}
            Story ID: ${{ needs.setup-and-plan.outputs.story_id }}

            Read/write state: .claude/skills/story-execution/temp-CI-notes.json

            INSTRUCTIONS:
            1. Read the plan file completely
            2. Review critically - identify any blocking or deferrable issues
            3. Extract task list from the plan
            4. Update temp-CI-notes.json with:
               - review.outcome: "proceed", "pause", or "proceed_with_review"
               - review.blocking_issues: [] if none
               - review.deferrable_issues: [] if none
               - tasks: [{id, name, status: "pending"}] extracted from plan
               - total_tasks: count of tasks
               - tasks_remaining: same as total_tasks initially
            5. If blocking issues exist, set outcome to "pause"
            6. If deferrable issues exist, set outcome to "proceed_with_review"
            7. If no issues, set outcome to "proceed"

            Load references:
            - references/critical-review.md

          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(python:*),Bash(python3:*),TodoWrite"
            --model claude-sonnet-4-5-20250929
            --max-turns 20

      - name: "5.1.3 Read review output"
        id: review-output
        if: always()
        run: |
          STATE_FILE=".claude/skills/story-execution/temp-CI-notes.json"
          if [ -f "$STATE_FILE" ]; then
            OUTCOME=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print(d.get('review',{}).get('outcome','unknown'))")
            if [ "$OUTCOME" = "proceed" ] || [ "$OUTCOME" = "proceed_with_review" ] || [ "$OUTCOME" = "pause" ]; then
              TASKS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print(d.get('total_tasks',0))")
              echo "outcome=$OUTCOME" >> $GITHUB_OUTPUT
              echo "total_tasks=$TASKS" >> $GITHUB_OUTPUT
              echo "review_completed=true" >> $GITHUB_OUTPUT
              echo "Review outcome: $OUTCOME, Total tasks: $TASKS"
            else
              echo "outcome=failed" >> $GITHUB_OUTPUT
              echo "total_tasks=0" >> $GITHUB_OUTPUT
              echo "review_completed=false" >> $GITHUB_OUTPUT
              echo "Review not completed - outcome in state: $OUTCOME"
            fi
          else
            echo "outcome=failed" >> $GITHUB_OUTPUT
            echo "total_tasks=0" >> $GITHUB_OUTPUT
            echo "review_completed=false" >> $GITHUB_OUTPUT
            echo "State file not found"
          fi

      - name: "5.1.4 Upload updated state"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/temp-CI-notes.json
          overwrite: true
          retention-days: 1

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # EXECUTE-BATCH-1: Phase 5.2 - Execute tasks 1-3
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  execute-batch-1:
    needs: [setup-and-plan, review-plan]
    if: |
      needs.review-plan.outputs.review_completed == 'true' &&
      (needs.review-plan.outputs.outcome == 'proceed' || needs.review-plan.outputs.outcome == 'proceed_with_review') &&
      needs.review-plan.outputs.total_tasks != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      status: ${{ steps.batch-output.outputs.status }}
      tasks_remaining: ${{ steps.batch-output.outputs.tasks_remaining }}
      batch_ran: ${{ steps.batch-output.outputs.batch_ran }}

    steps:
      - name: "5.2.0 Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: "5.2.1 Download state artifact"
        uses: actions/download-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/

      - name: "5.2.2 Execute batch 1"
        id: batch
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Use story-execution skill in CI mode.
            Phase: EXECUTE_BATCH
            Batch: 1
            Task Range: 1-3
            Plan: ${{ needs.setup-and-plan.outputs.plan_path }}
            Story ID: ${{ needs.setup-and-plan.outputs.story_id }}

            Read/write state: .claude/skills/story-execution/temp-CI-notes.json

            INSTRUCTIONS:
            1. Read temp-CI-notes.json for task list
            2. Execute tasks 1-3 (or fewer if less than 3 tasks total)
            3. For each task: RED (failing test) -> GREEN (implementation) -> COMMIT
            4. Commit format: "feat: [task] Story: ${{ needs.setup-and-plan.outputs.story_id }}"
            5. Update task status to "completed" or "failed" in temp-CI-notes.json
            6. Update batches[0] with status and commit hashes
            7. Update current_batch to 1 and tasks_remaining

            Load references:
            - references/tdd-execution.md
            - references/database-updates.md

          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(pytest:*),Bash(pip:*),BashOutput,TodoWrite"
            --model claude-sonnet-4-5-20250929
            --max-turns 30

      - name: "5.2.3 Read batch 1 output"
        id: batch-output
        if: always()
        run: |
          STATE_FILE=".claude/skills/story-execution/temp-CI-notes.json"
          if [ -f "$STATE_FILE" ]; then
            BATCH_EXISTS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); b=d.get('batches',[]); print('true' if len(b) >= 1 else 'false')")
            if [ "$BATCH_EXISTS" = "true" ]; then
              STATUS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); b=d.get('batches',[]); print(b[0].get('status','unknown'))")
              REMAINING=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print(d.get('tasks_remaining',0))")
              echo "status=$STATUS" >> $GITHUB_OUTPUT
              echo "tasks_remaining=$REMAINING" >> $GITHUB_OUTPUT
              echo "batch_ran=true" >> $GITHUB_OUTPUT
              echo "Batch 1 status: $STATUS, Remaining: $REMAINING"
            else
              echo "status=skipped" >> $GITHUB_OUTPUT
              echo "tasks_remaining=0" >> $GITHUB_OUTPUT
              echo "batch_ran=false" >> $GITHUB_OUTPUT
              echo "Batch 1 did not run"
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "tasks_remaining=0" >> $GITHUB_OUTPUT
            echo "batch_ran=false" >> $GITHUB_OUTPUT
          fi

      - name: "5.2.4 Upload updated state"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/temp-CI-notes.json
          overwrite: true
          retention-days: 1

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # EXECUTE-BATCH-2: Phase 5.3 - Execute tasks 4-6
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  execute-batch-2:
    needs: [setup-and-plan, execute-batch-1]
    if: |
      needs.execute-batch-1.outputs.batch_ran == 'true' &&
      needs.execute-batch-1.outputs.status == 'completed' &&
      needs.execute-batch-1.outputs.tasks_remaining != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      status: ${{ steps.batch-output.outputs.status }}
      tasks_remaining: ${{ steps.batch-output.outputs.tasks_remaining }}
      batch_ran: ${{ steps.batch-output.outputs.batch_ran }}

    steps:
      - name: "5.3.0 Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: "5.3.1 Download state artifact"
        uses: actions/download-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/

      - name: "5.3.2 Execute batch 2"
        id: batch
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Use story-execution skill in CI mode.
            Phase: EXECUTE_BATCH
            Batch: 2
            Task Range: 4-6
            Plan: ${{ needs.setup-and-plan.outputs.plan_path }}
            Story ID: ${{ needs.setup-and-plan.outputs.story_id }}

            Read/write state: .claude/skills/story-execution/temp-CI-notes.json

            INSTRUCTIONS:
            1. Read temp-CI-notes.json for task list and current progress
            2. Execute tasks 4-6 (or remaining tasks if fewer)
            3. For each task: RED -> GREEN -> COMMIT
            4. Update task status and batches[1] in temp-CI-notes.json
            5. Update current_batch to 2 and tasks_remaining

            Load references:
            - references/tdd-execution.md

          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(pytest:*),Bash(pip:*),BashOutput,TodoWrite"
            --model claude-sonnet-4-5-20250929
            --max-turns 30

      - name: "5.3.3 Read batch 2 output"
        id: batch-output
        if: always()
        run: |
          STATE_FILE=".claude/skills/story-execution/temp-CI-notes.json"
          if [ -f "$STATE_FILE" ]; then
            BATCH_EXISTS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); b=d.get('batches',[]); print('true' if len(b) >= 2 else 'false')")
            if [ "$BATCH_EXISTS" = "true" ]; then
              STATUS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); b=d.get('batches',[]); print(b[1].get('status','unknown'))")
              REMAINING=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print(d.get('tasks_remaining',0))")
              echo "status=$STATUS" >> $GITHUB_OUTPUT
              echo "tasks_remaining=$REMAINING" >> $GITHUB_OUTPUT
              echo "batch_ran=true" >> $GITHUB_OUTPUT
              echo "Batch 2 status: $STATUS, Remaining: $REMAINING"
            else
              echo "status=skipped" >> $GITHUB_OUTPUT
              echo "tasks_remaining=0" >> $GITHUB_OUTPUT
              echo "batch_ran=false" >> $GITHUB_OUTPUT
              echo "Batch 2 did not run"
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "tasks_remaining=0" >> $GITHUB_OUTPUT
            echo "batch_ran=false" >> $GITHUB_OUTPUT
          fi

      - name: "5.3.4 Upload updated state"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/temp-CI-notes.json
          overwrite: true
          retention-days: 1

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # EXECUTE-BATCH-3: Phase 5.4 - Execute tasks 7-9
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  execute-batch-3:
    needs: [setup-and-plan, execute-batch-2]
    if: |
      needs.execute-batch-2.outputs.batch_ran == 'true' &&
      needs.execute-batch-2.outputs.status == 'completed' &&
      needs.execute-batch-2.outputs.tasks_remaining != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      status: ${{ steps.batch-output.outputs.status }}
      tasks_remaining: ${{ steps.batch-output.outputs.tasks_remaining }}
      batch_ran: ${{ steps.batch-output.outputs.batch_ran }}

    steps:
      - name: "5.4.0 Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: "5.4.1 Download state artifact"
        uses: actions/download-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/

      - name: "5.4.2 Execute batch 3"
        id: batch
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Use story-execution skill in CI mode.
            Phase: EXECUTE_BATCH
            Batch: 3
            Task Range: 7-9
            Plan: ${{ needs.setup-and-plan.outputs.plan_path }}
            Story ID: ${{ needs.setup-and-plan.outputs.story_id }}

            Read/write state: .claude/skills/story-execution/temp-CI-notes.json

            Load references:
            - references/tdd-execution.md

          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(pytest:*),Bash(pip:*),BashOutput,TodoWrite"
            --model claude-sonnet-4-5-20250929
            --max-turns 30

      - name: "5.4.3 Read batch 3 output"
        id: batch-output
        if: always()
        run: |
          STATE_FILE=".claude/skills/story-execution/temp-CI-notes.json"
          if [ -f "$STATE_FILE" ]; then
            BATCH_EXISTS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); b=d.get('batches',[]); print('true' if len(b) >= 3 else 'false')")
            if [ "$BATCH_EXISTS" = "true" ]; then
              STATUS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); b=d.get('batches',[]); print(b[2].get('status','unknown'))")
              REMAINING=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print(d.get('tasks_remaining',0))")
              echo "status=$STATUS" >> $GITHUB_OUTPUT
              echo "tasks_remaining=$REMAINING" >> $GITHUB_OUTPUT
              echo "batch_ran=true" >> $GITHUB_OUTPUT
            else
              echo "status=skipped" >> $GITHUB_OUTPUT
              echo "tasks_remaining=0" >> $GITHUB_OUTPUT
              echo "batch_ran=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "tasks_remaining=0" >> $GITHUB_OUTPUT
            echo "batch_ran=false" >> $GITHUB_OUTPUT
          fi

      - name: "5.4.4 Upload updated state"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/temp-CI-notes.json
          overwrite: true
          retention-days: 1

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # EXECUTE-BATCH-4: Phase 5.5 - Execute tasks 10-12
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  execute-batch-4:
    needs: [setup-and-plan, execute-batch-3]
    if: |
      needs.execute-batch-3.outputs.batch_ran == 'true' &&
      needs.execute-batch-3.outputs.status == 'completed' &&
      needs.execute-batch-3.outputs.tasks_remaining != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      status: ${{ steps.batch-output.outputs.status }}
      tasks_remaining: ${{ steps.batch-output.outputs.tasks_remaining }}
      batch_ran: ${{ steps.batch-output.outputs.batch_ran }}

    steps:
      - name: "5.5.0 Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: "5.5.1 Download state artifact"
        uses: actions/download-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/

      - name: "5.5.2 Execute batch 4"
        id: batch
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Use story-execution skill in CI mode.
            Phase: EXECUTE_BATCH
            Batch: 4
            Task Range: 10-12
            Plan: ${{ needs.setup-and-plan.outputs.plan_path }}
            Story ID: ${{ needs.setup-and-plan.outputs.story_id }}

            Read/write state: .claude/skills/story-execution/temp-CI-notes.json

            Load references:
            - references/tdd-execution.md

          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(pytest:*),Bash(pip:*),BashOutput,TodoWrite"
            --model claude-sonnet-4-5-20250929
            --max-turns 30

      - name: "5.5.3 Read batch 4 output"
        id: batch-output
        if: always()
        run: |
          STATE_FILE=".claude/skills/story-execution/temp-CI-notes.json"
          if [ -f "$STATE_FILE" ]; then
            BATCH_EXISTS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); b=d.get('batches',[]); print('true' if len(b) >= 4 else 'false')")
            if [ "$BATCH_EXISTS" = "true" ]; then
              STATUS=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); b=d.get('batches',[]); print(b[3].get('status','unknown'))")
              REMAINING=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print(d.get('tasks_remaining',0))")
              echo "status=$STATUS" >> $GITHUB_OUTPUT
              echo "tasks_remaining=$REMAINING" >> $GITHUB_OUTPUT
              echo "batch_ran=true" >> $GITHUB_OUTPUT
            else
              echo "status=skipped" >> $GITHUB_OUTPUT
              echo "tasks_remaining=0" >> $GITHUB_OUTPUT
              echo "batch_ran=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "tasks_remaining=0" >> $GITHUB_OUTPUT
            echo "batch_ran=false" >> $GITHUB_OUTPUT
          fi

      - name: "5.5.4 Upload updated state"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/temp-CI-notes.json
          overwrite: true
          retention-days: 1

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # FINALIZE: Phases 6-7 - Archive, update DB, commit, push, report
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  finalize:
    needs: [setup-and-plan, review-plan, execute-batch-1, execute-batch-2, execute-batch-3, execute-batch-4]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "6.0 Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: "6.0.1 Download state artifact"
        if: needs.setup-and-plan.outputs.should_execute == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ci-state
          path: .claude/skills/story-execution/
        continue-on-error: true

      # ‚îÄ‚îÄ PHASE 5.6: Determine final execution status ‚îÄ‚îÄ
      - name: "5.6 Determine execution outcome"
        id: claude
        run: |
          STATE_FILE=".claude/skills/story-execution/temp-CI-notes.json"
          SHOULD_EXECUTE="${{ needs.setup-and-plan.outputs.should_execute }}"
          SKIP_REASON="${{ needs.setup-and-plan.outputs.skip_reason }}"

          # If setup determined we shouldn't execute, report that
          if [ "$SHOULD_EXECUTE" != "true" ]; then
            echo "outcome=skipped" >> $GITHUB_OUTPUT
            echo "reason=$SKIP_REASON" >> $GITHUB_OUTPUT
            exit 0
          fi

          REVIEW_COMPLETED="${{ needs.review-plan.outputs.review_completed }}"
          if [ "$REVIEW_COMPLETED" != "true" ]; then
            echo "outcome=failure" >> $GITHUB_OUTPUT
            echo "reason=review_failed" >> $GITHUB_OUTPUT
            exit 0
          fi

          REVIEW_OUTCOME="${{ needs.review-plan.outputs.outcome }}"
          if [ "$REVIEW_OUTCOME" = "pause" ]; then
            echo "outcome=paused" >> $GITHUB_OUTPUT
            echo "reason=blocking_issues" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check final state from artifact
          if [ -f "$STATE_FILE" ]; then
            REMAINING=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print(d.get('tasks_remaining',0))")
            FINAL=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print(d.get('final_status','unknown'))")

            if [ "$REMAINING" = "0" ] || [ "$FINAL" = "completed" ]; then
              if [ "$REVIEW_OUTCOME" = "proceed_with_review" ]; then
                echo "outcome=success" >> $GITHUB_OUTPUT
                echo "needs_review=true" >> $GITHUB_OUTPUT
              else
                echo "outcome=success" >> $GITHUB_OUTPUT
                echo "needs_review=false" >> $GITHUB_OUTPUT
              fi
            else
              FAILED=$(python3 -c "import json; d=json.load(open('$STATE_FILE')); print('yes' if any(b.get('status')=='failed' for b in d.get('batches',[])) else 'no')")
              if [ "$FAILED" = "yes" ]; then
                echo "outcome=failure" >> $GITHUB_OUTPUT
                echo "reason=batch_failed" >> $GITHUB_OUTPUT
              else
                echo "outcome=success" >> $GITHUB_OUTPUT
                echo "needs_review=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "outcome=failure" >> $GITHUB_OUTPUT
            echo "reason=no_state_file" >> $GITHUB_OUTPUT
          fi

      # ‚îÄ‚îÄ PHASE 6: FINALIZE ‚îÄ‚îÄ
      - name: "6.1 Archive executed plan"
        if: steps.claude.outputs.outcome == 'success'
        run: |
          PLAN_PATH="${{ needs.setup-and-plan.outputs.plan_path }}"
          FILENAME="${{ needs.setup-and-plan.outputs.plan_filename }}"
          ARCHIVE_DIR=".claude/data/executed"

          if [ -f "$PLAN_PATH" ]; then
            mkdir -p "$ARCHIVE_DIR"
            mv "$PLAN_PATH" "$ARCHIVE_DIR/"
            echo "‚úì Archived: $FILENAME ‚Üí $ARCHIVE_DIR/"
          else
            echo "Plan already archived or moved"
          fi

      - name: "6.2 Update story status in database"
        if: steps.claude.outputs.outcome == 'success' && needs.setup-and-plan.outputs.story_id != 'none'
        run: |
          STORY_ID="${{ needs.setup-and-plan.outputs.story_id }}"
          DB_PATH=".claude/data/story-tree.db"
          NEEDS_REVIEW="${{ steps.claude.outputs.needs_review }}"

          if [ ! -f "$DB_PATH" ]; then
            echo "Database not found, skipping status update"
            exit 0
          fi

          if [ "$NEEDS_REVIEW" = "true" ]; then
            STAGE="reviewing"
            NOTE="CI execution complete (review required)"
            REVIEW_FLAG=1
          else
            STAGE="verifying"
            NOTE="CI execution complete"
            REVIEW_FLAG=0
          fi

          python3 << PYEOF
          import sqlite3
          conn = sqlite3.connect("$DB_PATH")
          conn.execute('''
              UPDATE story_nodes
              SET stage = '$STAGE',
                  human_review = $REVIEW_FLAG,
                  notes = COALESCE(notes || char(10), '') || '$NOTE: ' || datetime('now'),
                  updated_at = datetime('now')
              WHERE id = ?
          ''', ("$STORY_ID",))
          conn.commit()
          print(f"‚úì Updated story $STORY_ID ‚Üí $STAGE")
          conn.close()
          PYEOF

      - name: "6.3 Stage all changes"
        if: steps.claude.outputs.outcome == 'success'
        id: stage
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes staged for commit:"
            git diff --cached --stat
          fi

      - name: "6.4 Commit changes"
        if: steps.stage.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          FILENAME="${{ needs.setup-and-plan.outputs.plan_filename }}"
          STORY_ID="${{ needs.setup-and-plan.outputs.story_id }}"

          git commit -m "ci: execute plan $FILENAME

          Story: $STORY_ID"

          echo "‚úì Committed changes"

      - name: "6.5 Push to remote"
        if: steps.stage.outputs.has_changes == 'true'
        run: |
          for attempt in 1 2 3 4; do
            if git push origin main; then
              echo "‚úì Push successful"
              exit 0
            else
              echo "Push failed (attempt $attempt), retrying in $((2 ** attempt))s..."
              sleep $((2 ** attempt))
            fi
          done
          echo "‚ùå Push failed after 4 attempts"
          exit 1

      # ‚îÄ‚îÄ PHASE 7: REPORTING ‚îÄ‚îÄ
      - name: "7.1 Generate execution summary"
        if: always()
        run: |
          echo "## Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PLAN_SELECTED="${{ needs.setup-and-plan.outputs.plan_selected }}"
          if [ "$PLAN_SELECTED" = "true" ]; then
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Plan | \`${{ needs.setup-and-plan.outputs.plan_filename }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Sequence | ${{ needs.setup-and-plan.outputs.plan_sequence }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Story ID | ${{ needs.setup-and-plan.outputs.story_id }} |" >> $GITHUB_STEP_SUMMARY

            OUTCOME="${{ steps.claude.outputs.outcome }}"
            case "$OUTCOME" in
              success)
                if [ "${{ steps.claude.outputs.needs_review }}" = "true" ]; then
                  echo "| Outcome | ‚úÖ Success (review required) |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| Outcome | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
                fi
                ;;
              paused)
                echo "| Outcome | ‚è∏Ô∏è Paused (blocking issues) |" >> $GITHUB_STEP_SUMMARY
                ;;
              failure)
                echo "| Outcome | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
                echo "| Reason | ${{ steps.claude.outputs.reason }} |" >> $GITHUB_STEP_SUMMARY
                ;;
              skipped)
                SKIP_REASON="${{ needs.setup-and-plan.outputs.skip_reason }}"
                case "$SKIP_REASON" in
                  already_executed)
                    echo "| Outcome | ‚è≠Ô∏è Skipped (already executed) |" >> $GITHUB_STEP_SUMMARY
                    ;;
                  deps_unmet)
                    echo "| Outcome | üöß Blocked (unmet deps) |" >> $GITHUB_STEP_SUMMARY
                    ;;
                  *)
                    echo "| Outcome | ‚è≠Ô∏è Skipped ($SKIP_REASON) |" >> $GITHUB_STEP_SUMMARY
                    ;;
                esac
                ;;
              *)
                echo "| Outcome | ‚ö†Ô∏è Unknown |" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          else
            echo "No plan files available for execution." >> $GITHUB_STEP_SUMMARY
          fi

      - name: "7.2 Report token usage"
        if: always() && needs.setup-and-plan.outputs.should_execute == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| setup-and-plan | ‚úÖ |" >> $GITHUB_STEP_SUMMARY

          REVIEW="${{ needs.review-plan.outputs.outcome }}"
          if [ -n "$REVIEW" ]; then
            echo "| review-plan | $REVIEW |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| review-plan | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          BATCH1="${{ needs.execute-batch-1.outputs.status }}"
          if [ -n "$BATCH1" ]; then
            echo "| execute-batch-1 | $BATCH1 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| execute-batch-1 | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          BATCH2="${{ needs.execute-batch-2.outputs.status }}"
          if [ -n "$BATCH2" ]; then
            echo "| execute-batch-2 | $BATCH2 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| execute-batch-2 | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          BATCH3="${{ needs.execute-batch-3.outputs.status }}"
          if [ -n "$BATCH3" ]; then
            echo "| execute-batch-3 | $BATCH3 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| execute-batch-3 | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          BATCH4="${{ needs.execute-batch-4.outputs.status }}"
          if [ -n "$BATCH4" ]; then
            echo "| execute-batch-4 | $BATCH4 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| execute-batch-4 | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "7.3 Post results to story issue"
        if: always() && needs.setup-and-plan.outputs.story_id != 'none' && needs.setup-and-plan.outputs.story_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STORY_ID="${{ needs.setup-and-plan.outputs.story_id }}"
          FILENAME="${{ needs.setup-and-plan.outputs.plan_filename }}"
          DB_PATH=".claude/data/story-tree.db"

          TITLE=""
          if [ -f "$DB_PATH" ]; then
            TITLE=$(python3 -c "import sqlite3; c=sqlite3.connect('$DB_PATH'); r=c.execute('SELECT title FROM story_nodes WHERE id=?',('$STORY_ID',)).fetchone(); print(r[0] if r else '')" 2>/dev/null)
          fi
          TITLE="${TITLE:-Story $STORY_ID}"

          ISSUE_TITLE="$STORY_ID - $TITLE"

          ISSUE_NUM=$(gh issue list --state all --search "\"$ISSUE_TITLE\" in:title" --json number,title --jq ".[] | select(.title == \"$ISSUE_TITLE\") | .number" | head -1)

          if [ -z "$ISSUE_NUM" ]; then
            ISSUE_NUM=$(gh issue create --title "$ISSUE_TITLE" --body "Tracking issue for story **$STORY_ID**" --label "story-tracking" 2>/dev/null | grep -oP 'issues/\K[0-9]+' || \
                        gh issue create --title "$ISSUE_TITLE" --body "Tracking issue for story **$STORY_ID**" | grep -oP 'issues/\K[0-9]+' || echo "")
          fi

          if [ -z "$ISSUE_NUM" ]; then
            echo "Could not find/create issue"
            exit 0
          fi

          OUTCOME="${{ steps.claude.outputs.outcome }}"
          case "$OUTCOME" in
            success)
              if [ "${{ steps.claude.outputs.needs_review }}" = "true" ]; then
                STATUS="‚úÖ Success (review required)"
              else
                STATUS="‚úÖ Success"
              fi
              ;;
            paused)
              STATUS="‚è∏Ô∏è Paused (blocking issues)"
              ;;
            failure)
              STATUS="‚ùå Failed"
              ;;
            skipped)
              SKIP_REASON="${{ needs.setup-and-plan.outputs.skip_reason }}"
              case "$SKIP_REASON" in
                already_executed) STATUS="‚è≠Ô∏è Skipped (already executed)" ;;
                deps_unmet) STATUS="üöß Blocked (unmet dependencies)" ;;
                *) STATUS="‚è≠Ô∏è Skipped ($SKIP_REASON)" ;;
              esac
              ;;
            *)
              STATUS="‚ö†Ô∏è $OUTCOME"
              ;;
          esac

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          BODY="## $STATUS

          **Plan:** \`$FILENAME\`
          **Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Run:** [View Details]($RUN_URL)

          ---
          *Posted by [execute-stories workflow]($RUN_URL)*"

          echo "$BODY" | gh issue comment "$ISSUE_NUM" --body-file -
          echo "Posted to issue #$ISSUE_NUM"
