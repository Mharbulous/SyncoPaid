name: Daily Story Planning

# Run at 2:30 AM PST (10:30 UTC) every day
on:
  schedule:
    - cron: '30 10 * * *'
  workflow_dispatch:  # Manual trigger for testing

concurrency:
  group: daily-story-planning
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  plan-story:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Run Claude Code to plan stories
        uses: anthropics/claude-code-action@v1
        with:
          # GitHub token for repository operations (required for scheduled workflows)
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Use OAuth token for Max subscription
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Show full output for debugging
          show_full_output: true

          # Direct prompt mode for scheduled automation
          prompt: |
            REPO: ${{ github.repository }}
            MODE: Daily Story Planning (YOLO mode - fully autonomous)

            You are running the automated story planning workflow for SyncoPaid.
            This is a scheduled CI run - complete all tasks autonomously without user interaction.

            ## Primary Task: Create Implementation Plan

            Run the /plan-story slash command to create an implementation plan for the highest-priority approved story.

            Key behaviors for YOLO mode:
            - Skip all approval steps - do NOT wait for user confirmation
            - Plan the single highest-priority approved story
            - Create commits directly with clear messages
            - No interactive prompts - complete the workflow autonomously

            ## Workflow Steps:

            1. Execute the /plan-story command which will:
               - Find approved stories in the story-tree database
               - Prioritize and select the best candidate
               - Use the story-planning skill to create a detailed plan
               - Save the plan to ai_docs/Plans/
               - Update the story's status to 'planned'
            2. Commit and push any changes (see "Git Operations" section below)

            ## Git Operations (REQUIRED for ANY file changes):

            **You MUST complete these steps for ANY changes made**:

            1. Ensure you are on main branch and pull latest:
               ```bash
               git checkout main
               git pull origin main
               ```
            2. Stage and commit all changes:
               ```bash
               git add -A
               git commit -m "planning: create implementation plan for story $(date -u +'%Y-%m-%d')"
               ```
            3. Push directly to main:
               ```bash
               git push origin main
               ```

            **CRITICAL**: Do NOT exit without pushing changes. Any local commits that are not pushed will be lost.

            ## Important Constraints:
            - Plan only 1 story per run
            - Only plan stories with status 'approved'
            - Plans are saved in ai_docs/Plans/ folder
            - 30-minute timeout - stop if exceeded

            If no approved stories exist, exit successfully without making any commits.

          # Tool permissions for file operations, database access, and git
          claude_args: |
            --allowedTools "Task,Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(sqlite3:*),Skill,SlashCommand,TodoWrite"
            --model claude-sonnet-4-5-20250929
