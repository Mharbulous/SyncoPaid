name: Streamline Source Files

on:
  schedule:
    # 10 runs between 1:30 AM and 7:00 AM PST, spaced 30 minutes apart
    # Skip 5:00 AM PST (13:00 UTC) - synthesize-goals-non-goals runs then
    # GitHub cron uses UTC only - PST is UTC-8
    - cron: '30 9 * * *'   # 1:30 AM PST
    - cron: '0 10 * * *'   # 2:00 AM PST
    - cron: '30 10 * * *'  # 2:30 AM PST
    - cron: '0 11 * * *'   # 3:00 AM PST
    - cron: '30 11 * * *'  # 3:30 AM PST
    - cron: '0 12 * * *'   # 4:00 AM PST
    - cron: '30 12 * * *'  # 4:30 AM PST
    - cron: '30 13 * * *'  # 5:30 AM PST
    - cron: '0 14 * * *'   # 6:00 AM PST
    - cron: '30 14 * * *'  # 6:30 AM PST
  workflow_dispatch:  # Manual trigger for testing

concurrency:
  group: 2amPST-streamline
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for branching

      - name: Run Claude Code Streamline
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: false

          prompt: |
            Read and execute the streamline skill at .claude/skills/streamline/SKILL.md in YOLO mode.

            This is an automated CI run. Follow the skill's YOLO mode workflow exactly:
            1. Load/update file inventory from references/file-inventory.json
            2. Select the largest file over 300 lines (excluding exceptions and already decomposed)
            3. Execute decomposition autonomously (no approval needed)
            4. Commit and push to main

            If no files need decomposition, exit successfully without commits.

          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(gh:*),Skill(*)"
            --model claude-sonnet-4-5-20250929
