name: Streamline Source Files

on:
  schedule:
    # 2:00 AM Vancouver time
    # GitHub cron uses UTC only - adjust twice yearly for DST:
    # - PST (Nov-Mar): 2am = 10:00 UTC → '0 10 * * *'
    # - PDT (Mar-Nov): 2am = 9:00 UTC  → '0 9 * * *'
    - cron: '0 10 * * *'
  workflow_dispatch:  # Manual trigger for testing

concurrency:
  group: 2amPST-streamline
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for branching

      - name: Run Claude Code Streamline
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: false

          prompt: |
            Read and execute the streamline skill at .claude/skills/streamline/SKILL.md in YOLO mode.

            This is an automated CI run. Follow the skill's YOLO mode workflow exactly:
            1. Load/update file inventory from references/file-inventory.json
            2. Select the largest file over 300 lines (excluding exceptions and already decomposed)
            3. Execute decomposition autonomously (no approval needed)
            4. Commit and push to main

            If no files need decomposition, exit successfully without commits.

          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(gh:*),Skill(*)"
            --model claude-sonnet-4-5-20250929
