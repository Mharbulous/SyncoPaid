name: Daily Visualization Update

# Run at 5:00 AM PST (13:00 UTC) every day
on:
  schedule:
    - cron: '0 13 * * *'
  workflow_dispatch:  # Manual trigger for testing

concurrency:
  group: daily-visualization
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  visualize:
    runs-on: ubuntu-latest
    name: Update vision documentation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Run Claude Code to generate visualization
        uses: anthropics/claude-code-action@v1
        with:
          # GitHub token for repository operations (required for scheduled workflows)
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Use OAuth token for Max subscription
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Show full output for debugging
          show_full_output: true

          # Direct prompt mode for scheduled automation
          prompt: |
            REPO: ${{ github.repository }}
            MODE: Daily Visualization Update (YOLO mode - fully autonomous)

            You are running the automated visualization workflow for SyncoPaid.
            This is a scheduled CI run - complete all tasks autonomously without user interaction.

            ## Primary Task: Generate Vision Documentation

            Run the /visualize slash command to generate/update vision documentation based on the story-tree database.

            Key behaviors for YOLO mode:
            - Skip all approval steps - do NOT wait for user confirmation
            - Generate vision documentation from approved story nodes
            - Create commits directly with clear messages
            - No interactive prompts - complete the workflow autonomously

            ## Workflow Steps:

            1. Read CLAUDE.md for project conventions
            2. Execute the /visualize command which will:
               - Use the visualization skill to analyze the story-tree database
               - Generate vision documentation in ai_docs/
               - Summarize what the vision IS (from approved nodes)
               - Summarize what the vision is NOT (from rejected nodes with notes)
            3. Commit and push any changes (see "Git Operations" section below)

            ## Git Operations (REQUIRED for ANY file changes):

            **You MUST complete these steps for ANY changes made**:

            1. Ensure you are on main branch and pull latest:
               ```bash
               git checkout main
               git pull origin main
               ```
            2. Stage and commit all changes:
               ```bash
               git add -A
               git commit -m "docs: auto-update visualization $(date -u +'%Y-%m-%d')"
               ```
            3. Push directly to main:
               ```bash
               git push origin main
               ```

            **CRITICAL**: Do NOT exit without pushing changes. Any local commits that are not pushed will be lost.

            ## Important Constraints:
            - Update vision documentation based on current story-tree state
            - Output files go in ai_docs/ folder
            - 30-minute timeout - stop if exceeded

            If the story-tree database doesn't exist or has no relevant data, exit successfully without making any commits.

          # Tool permissions for file operations, database access, and git
          claude_args: |
            --allowedTools "Task,Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(python:*),Bash(python3:*),Bash(sqlite3:*),Skill,SlashCommand,TodoWrite"
            --model claude-sonnet-4-5-20250929

      - name: Workflow summary
        run: |
          echo "## Daily Visualization Update" >> $GITHUB_STEP_SUMMARY
          echo "**Schedule**: 5:00 AM PST daily (1:00 PM UTC)" >> $GITHUB_STEP_SUMMARY
          echo "**Command**: \`/visualize\`" >> $GITHUB_STEP_SUMMARY
          echo "**Last run**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow automatically runs the \`/visualize\` slash command to generate vision documentation based on approved story nodes." >> $GITHUB_STEP_SUMMARY
