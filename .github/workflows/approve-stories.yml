name: Daily Story Approval (Human Only)

# This workflow previously auto-approved stories, but approvals must be done by human review.
# It now only reports on stories that would be eligible for approval.
on:
  schedule:
    - cron: '20 12 * * *'
  workflow_dispatch:  # Manual trigger for testing

concurrency:
  group: daily-story-approval
  cancel-in-progress: false

permissions:
  contents: read  # Read-only - no write permissions needed

jobs:
  report-pending-approvals:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Report stories awaiting human approval
        run: |
          echo "## Story Approval Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Story approvals require human review and cannot be automated in CI.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow has been disabled from making changes. To approve stories:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review concept stories locally using the story-tree skill" >> $GITHUB_STEP_SUMMARY
          echo "2. Evaluate each story against project goals and priorities" >> $GITHUB_STEP_SUMMARY
          echo "3. Approve stories manually after human review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Concepts Awaiting Human Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Query for concepts that would be eligible for approval
          python3 << 'REPORT_SCRIPT'
          import sqlite3
          import os

          db_path = '.claude/data/story-tree.db'
          if not os.path.exists(db_path):
              print("Database not found")
              exit(0)

          conn = sqlite3.connect(db_path)
          conn.row_factory = sqlite3.Row

          # Find all concept stories without holds (would have been auto-approved)
          concepts = conn.execute("""
              SELECT id, title, description
              FROM story_nodes
              WHERE stage = 'concept'
                AND hold_reason IS NULL
                AND disposition IS NULL
              ORDER BY updated_at ASC
          """).fetchall()

          if not concepts:
              print("✓ No concept stories currently awaiting approval.")
          else:
              print(f"Found {len(concepts)} concept(s) awaiting human review:")
              print("")
              for c in concepts:
                  print(f"- **{c['id']}**: {c['title'][:80]}")

          conn.close()
          REPORT_SCRIPT

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This workflow runs daily but makes no changes. Human approval is required.*" >> $GITHUB_STEP_SUMMARY
