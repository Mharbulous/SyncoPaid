name: Generate Execution Summary
description: Generate workflow run summary for GitHub Actions

inputs:
  plan_selected:
    description: Whether a plan was selected
    required: true
  plan_filename:
    description: Name of the plan file
    required: false
    default: ''
  plan_sequence:
    description: Plan sequence number
    required: false
    default: ''
  story_id:
    description: Story ID from setup
    required: false
    default: ''
  identified_story_id:
    description: Story ID from identify step
    required: false
    default: ''
  complexity:
    description: Plan complexity assessment
    required: false
    default: ''
  outcome:
    description: Final execution outcome
    required: true
  outcome_reason:
    description: Reason for outcome
    required: false
    default: ''
  needs_review:
    description: Whether review is needed
    required: false
    default: 'false'
  skip_reason:
    description: Reason for skipping
    required: false
    default: ''
  max_turns_exhausted:
    description: Whether max turns was exhausted
    required: false
    default: 'false'
  review_outcome:
    description: Review step outcome
    required: false
    default: ''
  execute_status:
    description: Execute step status
    required: false
    default: ''
  plan_blocked:
    description: Whether plan was blocked at identify
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    - name: Generate execution summary
      shell: bash
      run: |
        echo "## Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        PLAN_SELECTED="${{ inputs.plan_selected }}"
        if [ "$PLAN_SELECTED" = "true" ]; then
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Plan | \`${{ inputs.plan_filename }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Sequence | ${{ inputs.plan_sequence }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Story ID | ${{ inputs.story_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Complexity | ${{ inputs.complexity }} |" >> $GITHUB_STEP_SUMMARY

          # Add max-turns information if exhausted
          MAX_TURNS_EXHAUSTED="${{ inputs.max_turns_exhausted }}"
          if [ "$MAX_TURNS_EXHAUSTED" = "likely" ]; then
            echo "| Max-Turns | âš ï¸ **EXHAUSTED** (limit: 25) - check logs |" >> $GITHUB_STEP_SUMMARY
          fi

          OUTCOME="${{ inputs.outcome }}"
          case "$OUTCOME" in
            success)
              if [ "${{ inputs.needs_review }}" = "true" ]; then
                echo "| Outcome | âœ… Success (review required) |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| Outcome | âœ… Success |" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            verified)
              echo "| Outcome | âœ… Verified (already implemented) |" >> $GITHUB_STEP_SUMMARY
              ;;
            blocked)
              echo "| Outcome | ðŸš« Blocked (no Story ID found) |" >> $GITHUB_STEP_SUMMARY
              ;;
            partial)
              echo "| Outcome | âš ï¸ Partial (review required) |" >> $GITHUB_STEP_SUMMARY
              ;;
            paused)
              echo "| Outcome | â¸ï¸ Paused (blocking issues) |" >> $GITHUB_STEP_SUMMARY
              ;;
            failure)
              echo "| Outcome | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              if [ "$MAX_TURNS_EXHAUSTED" = "likely" ]; then
                echo "| Reason | ðŸ”„ Max-turns exhausted (limit: 25) - examine logs for root cause |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| Reason | ${{ inputs.outcome_reason }} |" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            skipped)
              SKIP_REASON="${{ inputs.skip_reason }}"
              case "$SKIP_REASON" in
                deps_unmet)
                  echo "| Outcome | ðŸš§ Blocked (unmet deps) |" >> $GITHUB_STEP_SUMMARY
                  ;;
                *)
                  echo "| Outcome | â­ï¸ Skipped ($SKIP_REASON) |" >> $GITHUB_STEP_SUMMARY
                  ;;
              esac
              ;;
            *)
              echo "| Outcome | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
        else
          echo "No plan files available for execution." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Report pipeline status
      if: inputs.plan_selected == 'true'
      shell: bash
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Pipeline Stages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| setup-and-plan | âœ… |" >> $GITHUB_STEP_SUMMARY

        STORY_ID="${{ inputs.story_id }}"
        if [ "$STORY_ID" = "none" ]; then
          PLAN_BLOCKED="${{ inputs.plan_blocked }}"
          IDENTIFIED_STORY_ID="${{ inputs.identified_story_id }}"
          if [ "$PLAN_BLOCKED" = "true" ]; then
            echo "| identify-plan | ðŸš« blocked (no match) |" >> $GITHUB_STEP_SUMMARY
          elif [ -n "$IDENTIFIED_STORY_ID" ] && [ "$IDENTIFIED_STORY_ID" != "none" ]; then
            echo "| identify-plan | âœ… matched ($IDENTIFIED_STORY_ID) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| identify-plan | â­ï¸ skipped |" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "| identify-plan | â­ï¸ skipped (has ID) |" >> $GITHUB_STEP_SUMMARY
        fi

        REVIEW="${{ inputs.review_outcome }}"
        if [ -n "$REVIEW" ]; then
          echo "| review-plan | $REVIEW |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| review-plan | â­ï¸ skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        COMPLEXITY="${{ inputs.complexity }}"
        if [ -n "$COMPLEXITY" ]; then
          echo "| decompose | $COMPLEXITY |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| decompose | â­ï¸ skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        EXECUTE="${{ inputs.execute_status }}"
        MAX_TURNS_EXHAUSTED="${{ inputs.max_turns_exhausted }}"
        if [ -n "$EXECUTE" ]; then
          if [ "$MAX_TURNS_EXHAUSTED" = "likely" ]; then
            echo "| execute | $EXECUTE âš ï¸ (max-turns exhausted) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| execute | $EXECUTE |" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "| execute | â­ï¸ skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "| finalize | ${{ inputs.outcome }} |" >> $GITHUB_STEP_SUMMARY
