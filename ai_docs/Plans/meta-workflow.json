{
  "version": "4.0",
  "name": "story-tree-orchestrator",
  "description": "Looping workflow that drains the pipeline before adding new work",

  "design_evolution": {
    "v1_issues": [
      "workflow_call misconception - doesn't provide true sequential runs",
      "Output communication complexity with Claude Code action",
      "State persistence challenges"
    ],
    "v2_issues": [
      "Over-engineered PAUSED state with idle tracking",
      "Git conflicts between sequential jobs",
      "State file commits add noise to history"
    ],
    "v3_issues": [
      "Wrong pipeline order - write then plan creates concept glut",
      "Single cycle per night - leaves work undone",
      "Synthesize-goals in loop - wrong cadence (only changes with user input)"
    ],
    "v4_changes": [
      "Reversed pipeline: plan-stories FIRST, then write-stories",
      "Loop until idle: continue until NO_CAPACITY AND NO_APPROVED",
      "Removed synthesize-goals from loop - separate daily workflow"
    ]
  },

  "configuration": {
    "repository_variables": {
      "STORY_AUTOMATION_ENABLED": {
        "type": "boolean_string",
        "values": ["true", "false"],
        "default": "true",
        "description": "Master switch - set to 'false' to disable all story automation",
        "how_to_change": "Settings > Secrets and variables > Actions > Variables"
      }
    },
    "secrets_required": [
      "CLAUDE_CODE_OAUTH_TOKEN",
      "GITHUB_TOKEN (automatic)"
    ]
  },

  "workflows": {
    "orchestrator": {
      "file": ".github/workflows/story-tree-orchestrator.yml",
      "triggers": {
        "schedule": {
          "cron": "0 10 * * *",
          "description": "Daily at 2:00 AM PST (10:00 UTC)"
        },
        "workflow_dispatch": {
          "inputs": {
            "max_cycles": {
              "type": "number",
              "default": 10,
              "description": "Maximum loop iterations (safety limit)"
            }
          }
        }
      },
      "concurrency": {
        "group": "story-tree-automation",
        "cancel_in_progress": false
      }
    }
  },

  "job_sequence": [
    {
      "job": "gate",
      "name": "Check if automation is enabled",
      "runs_on": "ubuntu-latest",
      "steps": [
        {
          "action": "Check STORY_AUTOMATION_ENABLED variable",
          "on_false": "Exit with success, skip all subsequent jobs"
        }
      ],
      "outputs": {
        "enabled": "true if should continue, false otherwise"
      }
    },
    {
      "job": "drain-pipeline",
      "name": "Loop: plan then write until idle",
      "needs": ["gate"],
      "condition": "needs.gate.outputs.enabled == 'true'",
      "runs_on": "ubuntu-latest",
      "description": "Single job that loops internally until pipeline is drained",
      "loop_logic": {
        "max_cycles": "inputs.max_cycles || 10",
        "exit_condition": "NO_APPROVED AND NO_CAPACITY (both idle)",
        "per_cycle": ["plan-stories", "write-stories"]
      },
      "steps": [
        { "action": "checkout", "with": { "fetch_depth": 0 } },
        { "action": "Setup Python environment" },
        {
          "action": "Loop until idle or max_cycles",
          "pseudo_code": [
            "cycle=0",
            "while cycle < max_cycles:",
            "  # Step 1: Plan stories (drain approved backlog)",
            "  approved_count = query_db('SELECT COUNT(*) FROM stories WHERE status=approved')",
            "  if approved_count > 0:",
            "    run_claude_code('story-planning-ci skill')",
            "    git_commit_push_if_changes()",
            "    plan_result = 'SUCCESS'",
            "  else:",
            "    plan_result = 'NO_APPROVED'",
            "  ",
            "  # Step 2: Write stories (fill capacity)",
            "  capacity_result = run('story_workflow.py --ci')",
            "  if capacity_result != 'NO_CAPACITY':",
            "    run_claude_code('generate story')",
            "    run('insert_story.py')",
            "    git_commit_push_if_changes()",
            "    write_result = 'SUCCESS'",
            "  else:",
            "    write_result = 'NO_CAPACITY'",
            "  ",
            "  # Check exit condition",
            "  if plan_result == 'NO_APPROVED' and write_result == 'NO_CAPACITY':",
            "    break  # Pipeline is idle",
            "  ",
            "  cycle += 1"
          ]
        },
        { "action": "Upload status artifact with cycle count and results" }
      ],
      "outputs": {
        "cycles_completed": "number of iterations run",
        "plans_created": "total plans created across all cycles",
        "stories_created": "total stories created across all cycles",
        "exit_reason": "IDLE | MAX_CYCLES | ERROR"
      }
    },
    {
      "job": "summary",
      "name": "Pipeline summary",
      "needs": ["drain-pipeline"],
      "condition": "always()",
      "runs_on": "ubuntu-latest",
      "steps": [
        { "action": "Download status artifact" },
        { "action": "Generate GITHUB_STEP_SUMMARY with loop results" }
      ]
    }
  ],

  "loop_exit_conditions": {
    "IDLE": {
      "condition": "NO_APPROVED AND NO_CAPACITY in same cycle",
      "meaning": "Pipeline fully drained - no approved stories to plan, no capacity for new stories",
      "action": "Exit loop gracefully"
    },
    "MAX_CYCLES": {
      "condition": "cycle >= max_cycles (default 10)",
      "meaning": "Safety limit reached - likely infinite loop scenario or very large backlog",
      "action": "Exit loop, report in summary"
    },
    "ERROR": {
      "condition": "Any step fails unexpectedly",
      "meaning": "Script error, Claude failure, git conflict",
      "action": "Exit loop, fail job"
    }
  },

  "pipeline_order_rationale": {
    "principle": "Drain before fill",
    "order": ["plan-stories", "write-stories"],
    "explanation": [
      "Plan first: Convert approved stories to plans (downstream work)",
      "Write second: Generate new concept stories (upstream work)",
      "This prevents concept glut - approved stories get planned before new ones are added"
    ],
    "analogy": "Like a factory: ship finished goods before starting new production"
  },

  "git_sync_strategy": {
    "within_loop": {
      "after_each_operation": "git add && commit && push (if changes)",
      "before_next_cycle": "git pull origin main (fetch remote changes)",
      "rationale": "Each plan/write operation commits immediately to avoid large commits"
    },
    "conflict_prevention": {
      "concurrency_group": "Prevents parallel orchestrator runs",
      "single_job": "All loop iterations in one job = no cross-job conflicts",
      "separate_files": "Plan operations modify ai_docs/Plans/, write operations modify stories DB"
    }
  },

  "state_diagram": {
    "mermaid": [
      "stateDiagram-v2",
      "    [*] --> ENABLED: Repository created",
      "    ",
      "    ENABLED --> ENABLED: Scheduled run (work found)",
      "    ENABLED --> ENABLED: Scheduled run (no work - exits early)",
      "    ENABLED --> DISABLED: User sets STORY_AUTOMATION_ENABLED=false",
      "    ",
      "    DISABLED --> DISABLED: Scheduled run (gate blocks)",
      "    DISABLED --> ENABLED: User sets STORY_AUTOMATION_ENABLED=true",
      "    ",
      "    note right of ENABLED: Always checks for work,\\nearly exit if none",
      "    note right of DISABLED: Gate job blocks all\\nsubsequent jobs"
    ]
  },

  "workflow_diagram": {
    "ascii": [
      "┌─────────────────────────────────────────────────────────────────┐",
      "│                    story-tree-orchestrator                      │",
      "│                  (runs daily at 2:00 AM PST)                    │",
      "└──────────────────────────────┬──────────────────────────────────┘",
      "                               │",
      "                               ▼",
      "                    ┌──────────────────────┐",
      "                    │        GATE          │",
      "                    │ Check if automation  │",
      "                    │    is enabled        │",
      "                    └──────────┬───────────┘",
      "                               │",
      "              ┌────────────────┴────────────────┐",
      "              │                                 │",
      "         [DISABLED]                       [ENABLED]",
      "              │                                 │",
      "              ▼                                 ▼",
      "        ┌──────────┐              ┌─────────────────────────────┐",
      "        │   EXIT   │              │      drain-pipeline         │",
      "        │ (skip)   │              │   (loop until idle)         │",
      "        └──────────┘              └─────────────┬───────────────┘",
      "                                                │",
      "                         ┌──────────────────────┼──────────────────────┐",
      "                         │                      │                      │",
      "                         │            ┌────────▼────────┐              │",
      "                         │            │  plan-stories   │              │",
      "                         │            │ (drain approved)│              │",
      "                         │            └────────┬────────┘              │",
      "                         │                     │                       │",
      "                         │         ┌──────────┴──────────┐             │",
      "                         │         │                     │             │",
      "                         │    [SUCCESS]           [NO_APPROVED]        │",
      "                         │         │                     │             │",
      "                         │         └──────────┬──────────┘             │",
      "                         │                    │                        │",
      "                         │           ┌───────▼────────┐                │",
      "                         │           │ write-stories  │                │",
      "                         │           │(fill capacity) │                │",
      "                         │           └───────┬────────┘                │",
      "                         │                   │                         │",
      "                         │        ┌─────────┴─────────┐                │",
      "                         │        │                   │                │",
      "                         │   [SUCCESS]          [NO_CAPACITY]          │",
      "                         │        │                   │                │",
      "                         │        │         ┌────────┴────────┐        │",
      "                         │        │         │ Both NO_*?      │        │",
      "                         │        │         └────────┬────────┘        │",
      "                         │        │                  │                 │",
      "                         │        │      ┌───────────┴───────────┐     │",
      "                         │        │      │                       │     │",
      "                         │        │    [YES]                   [NO]    │",
      "                         │        │      │                       │     │",
      "                         │        │      ▼                       │     │",
      "                         │        │   [IDLE]                     │     │",
      "                         │        │      │                       │     │",
      "                         │        └──────┴───────────────────────┘     │",
      "                         │                    │                        │",
      "                         │                    │ (loop back)            │",
      "                         └────────────────────┘                        │",
      "                                                                       │",
      "                                              ┌────────────────────────┘",
      "                                              │",
      "                                              ▼",
      "                                   ┌───────────────────────┐",
      "                                   │       summary         │",
      "                                   │   Report loop results │",
      "                                   │   GITHUB_STEP_SUMMARY │",
      "                                   └───────────────────────┘"
    ]
  },

  "separate_workflows": {
    "synthesize-goals-non-goals.yml": {
      "status": "Separate from orchestrator - runs independently",
      "schedule": "Once daily (existing schedule)",
      "rationale": "Only changes when user approves/rejects stories - no CI input",
      "keep": ["workflow_dispatch for manual runs", "existing schedule"]
    }
  },

  "existing_workflows": {
    "write-stories.yml": {
      "status": "Kept for manual runs, logic duplicated in orchestrator",
      "use_case": "Manual one-off story generation"
    },
    "plan-stories.yml": {
      "status": "Kept for manual runs, logic duplicated in orchestrator",
      "use_case": "Manual one-off planning"
    }
  },

  "implementation_notes": {
    "loop_implementation": {
      "approach": "Shell loop within single job",
      "rationale": "GitHub Actions doesn't support workflow-level loops",
      "alternative_considered": "Recursive workflow_dispatch - rejected due to complexity",
      "code_structure": "Bash while loop calling Python scripts and Claude Code action"
    },
    "claude_code_invocation": {
      "per_cycle": "Up to 2 Claude Code calls (plan + write)",
      "cost_consideration": "Loop has max_cycles limit to prevent runaway costs",
      "timeout": "Each Claude call should have reasonable timeout"
    },
    "recommendation": "Single drain-pipeline job with internal loop, keep existing workflows for manual use"
  }
}
